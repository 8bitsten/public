##########------------------------------------------------------##########
##########                  Used sowtware                       ##########
##########------------------------------------------------------##########

# make      : GNU Make 4.1
# Perl      : v5.32.0, built for x86_64-msys-thread-multi
# c1541.exe : VICE 3.6.1
# C64List   : 4.01

##########------------------------------------------------------##########
##########                   Configuration                      ##########
##########------------------------------------------------------##########
FILE_NAME    = stormtrp
FILE_NAME_UC = $(shell echo $(FILE_NAME) | tr a-z A-Z)
OUTPUT_DIR   = .\output
PERL	     = perl prefix_lines.pl
C1541	     = ..\..\..\_installed\GTK3VICE-3.6.1-win64\bin\c1541.exe
C64LIST	     = ..\..\..\_installed\C64List4.01\C64List.exe 

##########------------------------------------------------------##########
##########                       All                            ##########
##########------------------------------------------------------##########
all: tobas toprg tod64

rebuild: clean all

##########------------------------------------------------------##########
##########                 Convert to BAS                       ##########
##########------------------------------------------------------##########
tobas: mkdir
	$(PERL) $(FILE_NAME)_s.txt $(FILE_NAME)_c.txt $(OUTPUT_DIR)\$(FILE_NAME_UC).bas

##########------------------------------------------------------##########
##########                 Tokenize to PRG                      ##########
##########------------------------------------------------------##########
toprg: mkdir
	$(C64LIST) $(OUTPUT_DIR)\$(FILE_NAME).bas -prg -ovr

##########------------------------------------------------------##########
##########                    Make D64 disk                     ##########
##########------------------------------------------------------##########
tod64: mkdir
	$(C1541) -format diskname,id d64 $(OUTPUT_DIR)\$(FILE_NAME).d64 -attach $(OUTPUT_DIR)\$(FILE_NAME).d64 -write $(OUTPUT_DIR)\$(FILE_NAME).prg $(FILE_NAME)

##########------------------------------------------------------##########
##########                      Helpers                         ##########
##########------------------------------------------------------##########
mkdir:
	mkdir -p $(OUTPUT_DIR)

clean: 
	rm -rf $(OUTPUT_DIR)

##########------------------------------------------------------##########
##########    Extract BASIC source code from PRG within D64     ##########
##########------------------------------------------------------##########
revert:
	cp $(OUTPUT_DIR)/$(FILE_NAME).d64 .\$(FILE_NAME).d64
	$(C64LIST) $(FILE_NAME).d64::$(FILE_NAME_UC) -txt:$(OUTPUT_DIR)\$(FILE_NAME)_o.bas -ovr
	rm -f .\$(FILE_NAME).d64